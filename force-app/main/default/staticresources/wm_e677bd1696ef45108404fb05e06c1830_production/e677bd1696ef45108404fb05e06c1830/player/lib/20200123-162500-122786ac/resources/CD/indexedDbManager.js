function logError(e){try{console.log("Error: "+e)}catch(e){}}function IndexedDBManager(){var u,d=this,c="storage",s=50,l=5,e=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;function f(e,n,t,r,a){if(n)t(n);else if(u){var i=u.transaction([c],e);i.onerror=function(e){r&&r(e)};var o=i.objectStore(c);t&&t(o)}else setTimeout(function(){(a=a||0)<l&&f(e,n,t,r,a+1)},s)}function v(t,r,a,i,o){f("readwrite",null,function(n){d.getItem(r,a,function(e){e=t(e||{}),d.setItem(r,a,e,i,o,n)},o,n)},o)}d.init=function(n){try{var t=e.open("WalkMeStorage",2);t.onerror=function(e){logError("Error starting cross domain listening")},t.onblocked=function(e){logError("indexedDB open blocked")},t.onsuccess=function(e){u=t.result,n&&n()},t.onupgradeneeded=function(e){!function(e){e.objectStoreNames.contains(c)&&e.deleteObjectStore(c);e.createObjectStore(c,{keyPath:"uniqueKey"}).createIndex("guid","guid",{unique:!1})}(e.target.result)}}catch(e){logError(e)}},d.testConnection=function(e,n){u?e():n()},d.setItem=function(t,r,a,i,o,e){f("readwrite",e,function(e){var n=e.put({uniqueKey:t+r,guid:t,key:r,value:a});n.onsuccess=function(e){i&&i()},n.onerror=function(e){o&&o()}},o)},d.getItem=function(t,r,a,i,e){f("readwrite",e,function(e){var n=e.get(t+r);n.onsuccess=function(e){var n=e.target.result,t=n?n.value:void 0;a&&a(t)},n.onerror=function(e){i&&i()}},i)},d.getAll=function(a,i,e){f("readwrite",null,function(e){var t=[],n=e.index("guid"),r=IDBKeyRange.only(a);n.openCursor(r).onsuccess=function(e){var n=e.target.result;n?(void 0!==n.value.value&&t.push({key:n.value.key,saveObj:n.value.value}),n.continue()):i&&i(t)}},e)},d.removeItem=function(t,r,a,i){f("readwrite",null,function(e){var n=e.delete(t+r);n.onsuccess=function(e){a&&a()},n.onerror=function(e){i&&i()}},i)},d.addToDictionary=function(e,n,t,r,a,i,o){v(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return n[t]=r,e.value=JSON.stringify(n),e},e,n,a,i)},d.removeFromDictionary=function(e,n,t,r,a,i){v(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return delete n[t],e.value=JSON.stringify(n),e},e,n,r,a)},d.addToSet=function(i,o,u,c,s){f("readwrite",null,function(a){d.getItem(i,o,function(e){var n=[],t=u.value||[];e&&e.value&&(n=JSON.parse(e.value)||[]);for(var r=0;r<t.length;r++)-1==n.indexOf(t[r])&&n.push(t[r]);u.value=JSON.stringify(n),d.setItem(i,o,u,c,s,a)},s,a)},s)},d.increment=function(t,r,a,i,o,u,e){f("readwrite",e,function(n){d.getItem(t,r,function(e){(e=e||{value:0}).value!==a&&e.value++,e.saveTime=(new Date).getTime(),e.expireSeconds=i,d.setItem(t,r,e,function(){o&&o(e.value)},u,n)},u,n)},u)},d.getOrSetAndGet=function(t,r,a,i,o,u,e){f("readwrite",e,function(n){d.getItem(t,r,function(e){e?o&&o(JSON.parse(e.value)):(e={value:JSON.stringify(a),saveTime:(new Date).getTime(),expireSeconds:i},d.setItem(t,r,e,function(){o&&o(a)},u,n))},u,n)})},d.setDictionary=function(t,e,n,r,a){v(function(e){for(var n in t)"value"!=n&&t.hasOwnProperty(n)&&(e[n]=t[n]);return e},e,n,r,a)},function(){}.apply(null,arguments)}var indexedDb=new IndexedDBManager;function createCallback(n,t){return function(e){sendMessage({num:n,success:t,obj:e})}}function sendMessage(e){postMessage(JSON.stringify(e))}indexedDb.init(function(){sendMessage("ready")}),onmessage=function(e){var n=JSON.parse(e.data),t=n.num,r=n.guid,a=n.action,i=n.obj,o=createCallback(t,!0),u=createCallback(t,!1);switch(a){case"set":!1===i.clearDict?indexedDb.setDictionary(i.value,r,i.key,o,u):indexedDb.setItem(r,i.key,i.value,o,u);break;case"get":indexedDb.getItem(r,i.key,o,u);break;case"all":indexedDb.getAll(r,o,u);break;case"del":indexedDb.removeItem(r,i.key,o,u);break;case"add":indexedDb.addToDictionary(r,i.dict,i.key,i.value,o,u);break;case"addSet":indexedDb.addToSet(r,i.key,i.value,o,u);break;case"rem":indexedDb.removeFromDictionary(r,i.dict,i.key,o,u);break;case"test":indexedDb.testConnection(o,u);break;case"inc":indexedDb.increment(r,i.key,i.lastValue,i.ttl,o,u);break;case"getOrSet":indexedDb.getOrSetAndGet(r,i.key,i.fallbackValue,i.ttl,o,u)}};