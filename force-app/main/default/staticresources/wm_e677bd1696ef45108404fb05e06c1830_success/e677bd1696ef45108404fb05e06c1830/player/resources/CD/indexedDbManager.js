function IndexedDBManager(){this.LocalSVNRevision="$Rev: 2640 $";var c=this;var g="WalkMeStorage";var k="storage";var h=2;var m=50;var l=5;var a=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;var d;var b=0;function f(){}c.init=function j(p){try{var o=a.open(g,h);o.onerror=function(q){logError("Error starting cross domain listening");};o.onblocked=function(q){logError("indexedDB open blocked");};o.onsuccess=function(q){d=o.result;if(p){p();}};o.onupgradeneeded=function(q){e(q.target.result);};}catch(n){logError(n);}};c.setItem=function(q,o,r,p,n){b++;i("readwrite",function(s){var t=s.put({uniqueKey:q+o,guid:q,key:o,value:r});t.onsuccess=function(u){b--;if(p){p();}};t.onerror=function(u){if(n){n();}};},n);};c.getItem=function(q,o,p,n){i("readwrite",function(r){var s=r.get(q+o);s.onsuccess=function(t){var u=t.target.result;var v=u?u.value:undefined;if(p){p(v);}};s.onerror=function(t){if(n){n();}};},n);};c.getAll=function(p,o,n){i("readwrite",function(s){var q=[];var r=s.index("guid");var t=IDBKeyRange.only(p);r.openCursor(t).onsuccess=function(v){var u=v.target.result;if(u){if(u.value.value!==undefined){q.push({key:u.value.key,saveObj:u.value.value});}u["continue"]();}else{if(o){o(q);}}};},n);};c.removeItem=function(q,o,p,n){i("readwrite",function(r){var s=r["delete"](q+o);s.onsuccess=function(t){if(p){p();}};s.onerror=function(t){if(n){n();}};},n);};function i(p,n,o,r){if(!d){setTimeout(function(){if(!r){r=0;}if(r<l){i(p,n,o,r+1);}},m);return;}var s=d.transaction([k],p);s.onerror=function(t){if(o){o(t);}};var q=s.objectStore(k);if(n){n(q);}}function e(n){if(n.objectStoreNames.contains(k)){n.deleteObjectStore(k);}var o=n.createObjectStore(k,{keyPath:"uniqueKey"});o.createIndex("guid","guid",{unique:false});}f.apply(null,arguments);}var indexedDb=new IndexedDBManager();indexedDb.init(function(){postMessage("ready");});function createCallback(a,c,b){return function(d){postMessage({num:a,success:c,obj:d});};}onmessage=function(d){var b=d.data.num;var e=d.data.guid;var a=d.data.action;var c=d.data.obj;switch(a){case"set":indexedDb.setItem(e,c.key,c.value,createCallback(b,true,c.key),createCallback(b,false,c.key));break;case"get":indexedDb.getItem(e,c.key,createCallback(b,true),createCallback(b,false));break;case"all":indexedDb.getAll(e,createCallback(b,true),createCallback(b,false));break;case"del":indexedDb.removeItem(e,c.key,createCallback(b,true),createCallback(b,false));break;}};