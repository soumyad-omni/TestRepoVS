function logError(e){try{console.log("Error: "+e)}catch(n){}}function IndexedDBManager(){var e,n=this,t="WalkMeStorage",r="storage",o=2,i=50,a=5,u=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;function c(){}n.init=function(n){try{var r=u.open(t,o);r.onerror=function(e){logError("Error starting cross domain listening")},r.onblocked=function(e){logError("indexedDB open blocked")},r.onsuccess=function(t){e=r.result,n&&n()},r.onupgradeneeded=function(e){l(e.target.result)}}catch(i){logError(i)}},n.testConnection=function(n,t){e?n():t()},n.setItem=function(e,n,t,r,o,i){d("readwrite",i,function(i){var a=i.put({uniqueKey:e+n,guid:e,key:n,value:t});a.onsuccess=function(e){r&&r()},a.onerror=function(e){o&&o()}},o)},n.getItem=function(e,n,t,r,o){d("readwrite",o,function(o){var i=o.get(e+n);i.onsuccess=function(e){var n=e.target.result,r=n?n.value:void 0;t&&t(r)},i.onerror=function(e){r&&r()}},r)},n.getAll=function(e,n,t){d("readwrite",null,function(t){var r=[],o=t.index("guid"),i=IDBKeyRange.only(e);o.openCursor(i).onsuccess=function(e){var t=e.target.result;t?(void 0!==t.value.value&&r.push({key:t.value.key,saveObj:t.value.value}),t["continue"]()):n&&n(r)}},t)},n.removeItem=function(e,n,t,r){d("readwrite",null,function(o){var i=o["delete"](e+n);i.onsuccess=function(e){t&&t()},i.onerror=function(e){r&&r()}},r)},n.addToDictionary=function(e,n,t,r,o,i,a){s(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return n[t]=r,e.value=JSON.stringify(n),e},e,n,o,i)},n.removeFromDictionary=function(e,n,t,r,o,i){s(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return delete n[t],e.value=JSON.stringify(n),e},e,n,r,o)},n.addToSet=function(e,t,r,o,i,a){d("readwrite",null,function(a){n.getItem(e,t,function(u){u&&u.value&&(u=_json.parse(u.value)||[]);for(var c=0;c<r.length;c++)u.indexOf(r[c])==-1&&u.push(r[c]);n.setItem(e,t,_json.stringify(u),o,i,a)},i,a)},i)},n.increment=function(e,t,r,o,i,a,u){d("readwrite",u,function(u){n.getItem(e,t,function(c){c=c||{value:0},c.value!==r&&c.value++,c.saveTime=(new Date).getTime(),c.expireSeconds=o,n.setItem(e,t,c,function(){i&&i(c.value)},a,u)},a,u)},a)};function d(n,t,o,u,c){if(t)return void o(t);if(!e)return void setTimeout(function(){c||(c=0),c<a&&d(n,t,o,u,c+1)},i);var s=e.transaction([r],n);s.onerror=function(e){u&&u(e)};var l=s.objectStore(r);o&&o(l)}function s(e,t,r,o,i){d("readwrite",null,function(a){n.getItem(t,r,function(u){u=e(u||{}),n.setItem(t,r,u,o,i,a)},i,a)},i)}n.setDictionary=function(e,n,t,r,o){s(function(n){for(var t in e)"value"!=t&&e.hasOwnProperty(t)&&(n[t]=e[t]);return n},n,t,r,o)};function l(e){e.objectStoreNames.contains(r)&&e.deleteObjectStore(r);var n=e.createObjectStore(r,{keyPath:"uniqueKey"});n.createIndex("guid","guid",{unique:!1})}c.apply(null,arguments)}var indexedDb=new IndexedDBManager;indexedDb.init(function(){sendMessage("ready")});function createCallback(e,n){return function(t){sendMessage({num:e,success:n,obj:t})}}function sendMessage(e){postMessage(JSON.stringify(e))}onmessage=function(e){var n=JSON.parse(e.data),t=n.num,r=n.guid,o=n.action,i=n.obj,a=createCallback(t,!0),u=createCallback(t,!1);switch(o){case"set":i.clearDict===!1?indexedDb.setDictionary(i.value,r,i.key,a,u):indexedDb.setItem(r,i.key,i.value,a,u);break;case"get":indexedDb.getItem(r,i.key,a,u);break;case"all":indexedDb.getAll(r,a,u);break;case"del":indexedDb.removeItem(r,i.key,a,u);break;case"add":indexedDb.addToDictionary(r,i.dict,i.key,i.value,a,u);break;case"addSet":indexedDb.addToSet(r,i.key,i.value,a,u);break;case"rem":indexedDb.removeFromDictionary(r,i.dict,i.key,a,u);break;case"test":indexedDb.testConnection(a,u);break;case"inc":indexedDb.increment(r,i.key,i.lastValue,i.ttl,a,u)}};