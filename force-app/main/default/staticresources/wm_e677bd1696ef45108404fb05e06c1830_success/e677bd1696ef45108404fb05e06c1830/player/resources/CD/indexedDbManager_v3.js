function logError(b){try{console.log("Error: "+b);}catch(a){}}function IndexedDBManager(){this.LocalSVNRevision="$Rev: 3477 $";var b=this;var f="WalkMeStorage";var j="storage";var g=2;var l=50;var k=5;var a=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;var c;function e(){}b.init=function i(o){try{var n=a.open(f,g);n.onerror=function(p){logError("Error starting cross domain listening");};n.onblocked=function(p){logError("indexedDB open blocked");};n.onsuccess=function(p){c=n.result;if(o){o();}};n.onupgradeneeded=function(p){d(p.target.result);};}catch(m){logError(m);}};b.setItem=function(p,n,q,o,m){h("readwrite",function(r){var s=r.put({uniqueKey:p+n,guid:p,key:n,value:q});s.onsuccess=function(t){if(o){o();}};s.onerror=function(t){if(m){m();}};},m);};b.getItem=function(p,n,o,m){h("readwrite",function(q){var r=q.get(p+n);r.onsuccess=function(s){var t=s.target.result;var u=t?t.value:undefined;if(o){o(u);}};r.onerror=function(s){if(m){m();}};},m);};b.getAll=function(o,n,m){h("readwrite",function(r){var p=[];var q=r.index("guid");var s=IDBKeyRange.only(o);q.openCursor(s).onsuccess=function(u){var t=u.target.result;if(t){if(t.value.value!==undefined){p.push({key:t.value.key,saveObj:t.value.value});}t["continue"]();}else{if(n){n(p);}}};},m);};b.removeItem=function(p,n,o,m){h("readwrite",function(q){var r=q["delete"](p+n);r.onsuccess=function(s){if(o){o();}};r.onerror=function(s){if(m){m();}};},m);};b.addToDictionary=function(r,m,o,s,p,q,n){h("readwrite",function(t){var u=t.get(r+m);u.onsuccess=function(w){var y=w.target.result||{};if(!y.value){y.value={};}var v=y.value.value?JSON.parse(y.value.value):{};v=v||{};if(p){y.value[o]=s;}else{v[o]=s;}y.value.value=JSON.stringify(v);var x=t.put({uniqueKey:r+m,guid:r,key:m,value:y.value});x.onsuccess=function(){if(q){q(s);}};x.onerror=function(z){if(n){n();}};};u.onerror=function(v){if(n){n();}};},n);};function h(o,m,n,q){if(!c){setTimeout(function(){if(!q){q=0;}if(q<k){h(o,m,n,q+1);}},l);return;}var r=c.transaction([j],o);r.onerror=function(s){if(n){n(s);}};var p=r.objectStore(j);if(m){m(p);}}function d(m){if(m.objectStoreNames.contains(j)){m.deleteObjectStore(j);}var n=m.createObjectStore(j,{keyPath:"uniqueKey"});n.createIndex("guid","guid",{unique:false});}e.apply(null,arguments);}var indexedDb=new IndexedDBManager();indexedDb.init(function(){sendMessage("ready");});function createCallback(a,c,b){return function(d){sendMessage({num:a,success:c,obj:d});};}function sendMessage(a){postMessage(JSON.stringify(a));}onmessage=function(e){var g=JSON.parse(e.data);var b=g.num;var f=g.guid;var a=g.action;var d=g.obj;switch(a){case"set":if(d.clearDict===false){for(var h in d.value){if(d.value.hasOwnProperty(h)){indexedDb.addToDictionary(f,d.key,h,d.value[h],true);}}var c=createCallback(b,true);if(c){c();}}else{indexedDb.setItem(f,d.key,d.value,createCallback(b,true,d.key),createCallback(b,false,d.key));}break;case"get":indexedDb.getItem(f,d.key,createCallback(b,true),createCallback(b,false));break;case"all":indexedDb.getAll(f,createCallback(b,true),createCallback(b,false));break;case"del":indexedDb.removeItem(f,d.key,createCallback(b,true),createCallback(b,false));break;case"add":indexedDb.addToDictionary(f,d.dict,d.key,d.value,false,createCallback(b,true),createCallback(b,false));}};