function logError(e){try{console.log("Error: "+e)}catch(n){}}function IndexedDBManager(){var e,n=this,t="WalkMeStorage",r="storage",a=2,i=50,o=5,u=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;function c(){}n.init=function(n){try{var r=u.open(t,a);r.onerror=function(e){logError("Error starting cross domain listening")},r.onblocked=function(e){logError("indexedDB open blocked")},r.onsuccess=function(t){e=r.result,n&&n()},r.onupgradeneeded=function(e){l(e.target.result)}}catch(i){logError(i)}},n.testConnection=function(n,t){e?n():t()},n.setItem=function(e,n,t,r,a,i){d("readwrite",i,function(i){var o=i.put({uniqueKey:e+n,guid:e,key:n,value:t});o.onsuccess=function(e){r&&r()},o.onerror=function(e){a&&a()}},a)},n.getItem=function(e,n,t,r,a){d("readwrite",a,function(a){var i=a.get(e+n);i.onsuccess=function(e){var n=e.target.result,r=n?n.value:void 0;t&&t(r)},i.onerror=function(e){r&&r()}},r)},n.getAll=function(e,n,t){d("readwrite",null,function(t){var r=[],a=t.index("guid"),i=IDBKeyRange.only(e);a.openCursor(i).onsuccess=function(e){var t=e.target.result;t?(void 0!==t.value.value&&r.push({key:t.value.key,saveObj:t.value.value}),t["continue"]()):n&&n(r)}},t)},n.removeItem=function(e,n,t,r){d("readwrite",null,function(a){var i=a["delete"](e+n);i.onsuccess=function(e){t&&t()},i.onerror=function(e){r&&r()}},r)},n.addToDictionary=function(e,n,t,r,a,i,o){s(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return n[t]=r,e.value=JSON.stringify(n),e},e,n,a,i)},n.removeFromDictionary=function(e,n,t,r,a,i){s(function(e){var n=(e.value?JSON.parse(e.value):{})||{};return delete n[t],e.value=JSON.stringify(n),e},e,n,r,a)},n.addToSet=function(e,t,r,a,i,o){d("readwrite",null,function(o){n.getItem(e,t,function(u){var c=[],d=r.value||[];u&&u.value&&(c=JSON.parse(u.value)||[]);for(var s=0;s<d.length;s++)c.indexOf(d[s])==-1&&c.push(d[s]);r.value=JSON.stringify(c),n.setItem(e,t,r,a,i,o)},i,o)},i)},n.increment=function(e,t,r,a,i,o,u){d("readwrite",u,function(u){n.getItem(e,t,function(c){c=c||{value:0},c.value!==r&&c.value++,c.saveTime=(new Date).getTime(),c.expireSeconds=a,n.setItem(e,t,c,function(){i&&i(c.value)},o,u)},o,u)},o)},n.getOrSetAndGet=function(e,t,r,a,i,o,u){d("readwrite",u,function(u){n.getItem(e,t,function(c){c?i&&i(JSON.parse(c.value)):(c={value:JSON.stringify(r),saveTime:(new Date).getTime(),expireSeconds:a},n.setItem(e,t,c,function(){i&&i(r)},o,u))},o,u)})};function d(n,t,a,u,c){if(t)return void a(t);if(!e)return void setTimeout(function(){c||(c=0),c<o&&d(n,t,a,u,c+1)},i);var s=e.transaction([r],n);s.onerror=function(e){u&&u(e)};var l=s.objectStore(r);a&&a(l)}function s(e,t,r,a,i){d("readwrite",null,function(o){n.getItem(t,r,function(u){u=e(u||{}),n.setItem(t,r,u,a,i,o)},i,o)},i)}n.setDictionary=function(e,n,t,r,a){s(function(n){for(var t in e)"value"!=t&&e.hasOwnProperty(t)&&(n[t]=e[t]);return n},n,t,r,a)};function l(e){e.objectStoreNames.contains(r)&&e.deleteObjectStore(r);var n=e.createObjectStore(r,{keyPath:"uniqueKey"});n.createIndex("guid","guid",{unique:!1})}c.apply(null,arguments)}var indexedDb=new IndexedDBManager;indexedDb.init(function(){sendMessage("ready")});function createCallback(e,n){return function(t){sendMessage({num:e,success:n,obj:t})}}function sendMessage(e){postMessage(JSON.stringify(e))}onmessage=function(e){var n=JSON.parse(e.data),t=n.num,r=n.guid,a=n.action,i=n.obj,o=createCallback(t,!0),u=createCallback(t,!1);switch(a){case"set":i.clearDict===!1?indexedDb.setDictionary(i.value,r,i.key,o,u):indexedDb.setItem(r,i.key,i.value,o,u);break;case"get":indexedDb.getItem(r,i.key,o,u);break;case"all":indexedDb.getAll(r,o,u);break;case"del":indexedDb.removeItem(r,i.key,o,u);break;case"add":indexedDb.addToDictionary(r,i.dict,i.key,i.value,o,u);break;case"addSet":indexedDb.addToSet(r,i.key,i.value,o,u);break;case"rem":indexedDb.removeFromDictionary(r,i.dict,i.key,o,u);break;case"test":indexedDb.testConnection(o,u);break;case"inc":indexedDb.increment(r,i.key,i.lastValue,i.ttl,o,u);break;case"getOrSet":indexedDb.getOrSetAndGet(r,i.key,i.fallbackValue,i.ttl,o,u)}};