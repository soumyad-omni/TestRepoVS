function logError(b){try{console.log("Error: "+b);}catch(a){}}function IndexedDBManager(){this.LocalSVNRevision="$Rev: 3788 $";var b=this;var f="WalkMeStorage";var j="storage";var g=2;var m=50;var l=5;var a=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;var c;function e(){}b.init=function i(p){try{var o=a.open(f,g);o.onerror=function(q){logError("Error starting cross domain listening");};o.onblocked=function(q){logError("indexedDB open blocked");};o.onsuccess=function(q){c=o.result;if(p){p();}};o.onupgradeneeded=function(q){d(q.target.result);};}catch(n){logError(n);}};b.testConnection=function(o,n){c?o():n();};b.setItem=function(r,o,s,q,n,p){h("readwrite",p,function(t){var u=t.put({uniqueKey:r+o,guid:r,key:o,value:s});u.onsuccess=function(v){if(q){q();}};u.onerror=function(v){if(n){n();}};},n);};b.getItem=function(r,o,q,n,p){h("readwrite",p,function(s){var t=s.get(r+o);t.onsuccess=function(u){var v=u.target.result;var w=v?v.value:undefined;if(q){q(w);}};t.onerror=function(u){if(n){n();}};},n);};b.getAll=function(p,o,n){h("readwrite",null,function(s){var q=[];var r=s.index("guid");var t=IDBKeyRange.only(p);r.openCursor(t).onsuccess=function(v){var u=v.target.result;if(u){if(u.value.value!==undefined){q.push({key:u.value.key,saveObj:u.value.value});}u["continue"]();}else{if(o){o(q);}}};},n);};b.removeItem=function(q,o,p,n){h("readwrite",null,function(r){var s=r["delete"](q+o);s.onsuccess=function(t){if(p){p();}};s.onerror=function(t){if(n){n();}};},n);};b.addToDictionary=function(s,n,p,t,r,o,q){k(function(u){var v=(u.value?JSON.parse(u.value):{})||{};v[p]=t;u.value=JSON.stringify(v);return u;},s,n,r,o);};b.increment=function(t,o,p,s,r,n,q){h("readwrite",q,function(u){b.getItem(t,o,function(v){v=v||{value:0};if(v.value!==p){v.value++;}v.saveTime=new Date().getTime();v.expireSeconds=s;b.setItem(t,o,v,function(){if(r){r(v.value);}},n,u);},n,u);},n);};function h(p,s,n,o,r){if(s){n(s);return;}if(!c){setTimeout(function(){if(!r){r=0;}if(r<l){h(p,s,n,o,r+1);}},m);return;}var t=c.transaction([j],p);t.onerror=function(u){if(o){o(u);}};var q=t.objectStore(j);if(n){n(q);}}function k(q,r,n,p,o){h("readwrite",null,function(s){b.getItem(r,n,function(t){t=q(t||{});b.setItem(r,n,t,p,o,s);},o,s);},o);}b.setDictionary=function(n,r,o,q,p){k(function(s){for(var t in n){if(t!="value"&&n.hasOwnProperty(t)){s[t]=n[t];}}return s;},r,o,q,p);};function d(n){if(n.objectStoreNames.contains(j)){n.deleteObjectStore(j);}var o=n.createObjectStore(j,{keyPath:"uniqueKey"});o.createIndex("guid","guid",{unique:false});}e.apply(null,arguments);}var indexedDb=new IndexedDBManager();indexedDb.init(function(){sendMessage("ready");});function createCallback(a,b){return function(c){sendMessage({num:a,success:b,obj:c});};}function sendMessage(a){postMessage(JSON.stringify(a));}onmessage=function(d){var g=JSON.parse(d.data);var b=g.num;var f=g.guid;var a=g.action;var c=g.obj;var h=createCallback(b,true);var e=createCallback(b,false);switch(a){case"set":if(c.clearDict===false){indexedDb.setDictionary(c.value,f,c.key,h,e);}else{indexedDb.setItem(f,c.key,c.value,h,e);}break;case"get":indexedDb.getItem(f,c.key,h,e);break;case"all":indexedDb.getAll(f,h,e);break;case"del":indexedDb.removeItem(f,c.key,h,e);break;case"add":indexedDb.addToDictionary(f,c.dict,c.key,c.value,h,e);break;case"test":indexedDb.testConnection(h,e);break;case"inc":indexedDb.increment(f,c.key,c.lastValue,c.ttl,h,e);}};